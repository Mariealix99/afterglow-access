<div
  class="viewer-panel"
  [class.focused]="hasFocus"
  style="height: 100%"
>
  <mat-tab-group
    class="mat-tab-fill-height"
    style="height: 100%"
    [animationDuration]="'0ms'"
    [selectedIndex]="selectedViewerIndex"
    (selectedIndexChange)="onSelectedViewerIndexChange($event)"
  >
    <mat-tab *ngFor="let viewer of (viewers$ | async); trackBy: viewerTrackByFn">
      <ng-template mat-tab-label>
        <div
          class="file-path-tab-label"
          [class.active-viewer]="
            selectedViewerId == viewer.viewerId && hasFocus
          "
          [class.inactive-viewer]="
            selectedViewerId != viewer.viewerId || !hasFocus
          "
          (mouseup)="$event.which === 2 ? closeViewer(viewer.viewerId) : null"
          (mousedown)="setFocusedViewer($event, viewer.viewerId, viewer)"
          fxLayout="row"
          fxFlexFill
        >
          <div
            fxFlex="1 1 auto"
            class="label"
            [style.font-style]="viewer.keepOpen ? 'normal' : 'italic'"
            (contextmenu)="onContextMenu($event, viewer)"
            matTooltipClass="file-path-tooltip"
            [matTooltip]="(files$ | async)[viewer.fileId]?.assetPath"
            matTooltipShowDelay="500"
          >
            <span class="ml-4">
              {{ (files$ | async)[viewer.fileId]?.name }}</span
            >
          </div>
          <div
            fxFlex="0 0 auto"
            class="icon-group"
            (mouseenter)="mouseOverCloseViewerId = viewer.viewerId"
            (mouseleave)="mouseOverCloseViewerId = null"
          >
            <span class="mr-2 ml-2">
              <button
                class="close-button"
                mat-icon-button
                aria-label="Close"
                (click)="closeViewer(viewer.viewerId)"
                matTooltipClass="file-path-tooltip"
                matTooltip="Close Viewer"
                matTooltipShowDelay="500"
              >
                <mat-icon class="close-button">close</mat-icon>
              </button>
            </span>
          </div>
        </div>
      </ng-template>
      <app-workbench-viewer
        (mousedown)="setFocusedViewer($event, viewer.viewerId, viewer)"
        [fileId]="viewer.fileId"
        [active]="
          selectedViewerId == viewer.viewerId && primaryViewerHasFocus
        "
        [markers]="viewer.markers"
        (onImageMove)="handleImageMove($event, viewer.viewerId, viewer)"
        (onImageClick)="handleImageClick($event, viewer.viewerId, viewer)"
        (onMarkerClick)="handleMarkerClick($event, viewer.viewerId, viewer)"
      >
      </app-workbench-viewer>
    </mat-tab>
  </mat-tab-group>
</div>

<div
  style="visibility: hidden; position: fixed"
  [style.left]="contextMenuPosition.x"
  [style.top]="contextMenuPosition.y"
  [matMenuTriggerFor]="contextMenu"
></div>

<mat-menu #contextMenu="matMenu">
  <ng-template matMenuContent let-viewer="viewer">
    <button
      mat-menu-item
      [hidden]="viewer.keepOpen"
      (click)="keepViewerOpen(viewer.viewerId)"
    >
      Keep Open
    </button>
    <button
      mat-menu-item
      [disabled]="primaryViewers.includes(viewer) && primaryViewers.length == 1"
      (click)="moveToOtherView(viewer.viewerId)"
    >
      Move to Other View
    </button>
  </ng-template>
</mat-menu>
