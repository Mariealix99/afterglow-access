<ng-template #fileNotSelectedBlock>
  <div i18n class="alert alert-info" i18n>Select a file or image layer to see the display settings.</div>
</ng-template>

<ng-template #invalidLayerTypeBlock>
  <div i18n class="alert alert-info" i18n>Select an image layer to adjust brightness and contrast settings.</div>
</ng-template>

<ng-container *ngIf="file$ | async as file; else fileNotSelectedBlock">
  <ng-container *ngIf="activeLayer$ | async as layer; else multiLayerBlock">
    <ng-container *ngIf="activeImageLayer$ | async as activeImageLayer; else invalidLayerTypeBlock">

      <div *ngIf="activeImageLayer.histogram?.loaded" class="pr-3 pl-3 pb-0 w-100" style="height: 400px;">
        <app-image-histogram-chart [data]="[activeHistData$ | async]"
          [backgroundLevel]="activeImageLayer?.normalizer?.backgroundLevel"
          [peakLevel]="activeImageLayer?.normalizer?.peakLevel">
        </app-image-histogram-chart>
        <div style="clear: both"></div>
      </div>



      <div class="pt-1">
        <h3 i18n>Brightness and Contrast Settings</h3>
        <div class="pb-4" fxLayout="row wrap" fxLayoutGap="5px">
          <div class="m-2">
            <button mat-raised-button (click)="onPresetClick( 'faint')" i18n-aria-label
              aria-label="Faint Target Preset">
              <mat-icon>brightness_3</mat-icon><span i18n>Faint Target</span>
            </button>
          </div>
          <div class="m-2">
            <button mat-raised-button (click)="onPresetClick('default')" i18n-aria-label aria-label="Default Preset">
              <mat-icon>brightness_2</mat-icon><span i18n>Default Preset</span>
            </button>
          </div>
          <div class="m-2">
            <button mat-raised-button (click)="onPresetClick('bright')" i18n-aria-label
              aria-label="Bright Target Preset">
              <mat-icon>brightness_5</mat-icon><span i18n>Bright Target</span>
            </button>
          </div>


        </div>
        <app-normalizer-form [normalizer]="activeImageLayer?.normalizer"
          [showLayerScale]="(file$ |async)?.colorBalanceMode != ColorBalanceMode.PERCENTILE"
          [showLayerOffset]="(file$ |async)?.colorBalanceMode != ColorBalanceMode.PERCENTILE"
          (backgroundPercentileChange)="onBackgroundPercentileChange($event)"
          (midPercentileChange)="onMidPercentileChange($event)" (peakPercentileChange)="onPeakPercentileChange($event)"
          (backgroundLevelChange)="onBackgroundLevelChange($event)" (midLevelChange)="onMidLevelChange($event)"
          (peakLevelChange)="onPeakLevelChange($event)" (colorMapChange)="onColorMapChange(activeImageLayer, $event)"
          (stretchModeChange)="onStretchModeChange($event)"
          (invertedChange)="onInvertedChange(activeImageLayer, $event)"
          (layerScaleChange)="onLayerScaleChange(activeImageLayer, $event)"
          (layerOffsetChange)="onLayerOffsetChange(activeImageLayer, $event)"
          (modeChange)="onNormalizerModeChange($event)">
        </app-normalizer-form>
      </div>




    </ng-container>
  </ng-container>


  <ng-template #multiLayerBlock>

    <ng-container *ngIf="layers$ | async; let layers">
      <div *ngIf="layers.length > 1" fxLayout="column">
        <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start start" fxLayoutGap="40px">
          <mat-form-field appearance="outline">
            <mat-label i18n>Color Balance Mode</mat-label>
            <mat-select [value]="(file$ |async)?.colorBalanceMode"
              (selectionChange)="setFileColorBalanceModeEvent$.next($event.value)">
              <mat-option [value]="ColorBalanceMode.PERCENTILE" i18n>Percentile</mat-option>
              <mat-option [value]="ColorBalanceMode.HISTOGRAM_FITTING" i18n>Histogram Fitting</mat-option>
            </mat-select>
          </mat-form-field>
          <button *ngIf="(file$ |async)?.colorBalanceMode == ColorBalanceMode.HISTOGRAM_FITTING" mat-raised-button
            style="height: 36px" [matMenuTriggerFor]="histogramFittingMenu">
            <ng-container i18n>Histogram Fitting Tools</ng-container>
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </div>
        <mat-menu #histogramFittingMenu="matMenu">
          <button mat-menu-item (click)="neutralizeBackgroundsEvent$.next();" i18n-aria-label
            aria-label="Neutralize Background">
            <mat-icon class="mr-2">balance</mat-icon><span i18n>Neutralize Background</span>
          </button>
          <button mat-menu-item (click)="neutralizeSourcesEvent$.next();" i18n-aria-label
            aria-label="Neutralize Sources">
            <mat-icon class="mr-2">light_mode</mat-icon><span i18n>Neutralize Sources...</span>
          </button>
          <button mat-menu-item (click)="this.photometricColorBalanceEvent$.next()" i18n-aria-label
            aria-label="Photometric Color Calibration...">
            <mat-icon class="mr-2">star</mat-icon><span i18n>Photometric Color Calibration...</span>
          </button>
          <button mat-menu-item (click)="resetColorBalanceEvent$.next(true)" i18n-aria-label
            aria-label="Reset Histograms">
            <mat-icon>refresh</mat-icon><span i18n>Reset Histogram Fitting</span>
          </button>
        </mat-menu>



        <div class="pr-3 pl-3 pb-0 w-100" style="height: 400px;">
          <app-image-histogram-chart [data]="compositeHistData$ | async"
            [backgroundLevel]="(file$ |async)?.colorBalanceMode == ColorBalanceMode.HISTOGRAM_FITTING ? (compositeNormalizer$ | async)?.backgroundLevel : null"
            [peakLevel]="(file$ |async)?.colorBalanceMode == ColorBalanceMode.HISTOGRAM_FITTING ?  (compositeNormalizer$ | async)?.peakLevel : null">
          </app-image-histogram-chart>

        </div>
        <div style="clear: both"></div>

        <!-- <div class="p-4">
          <mat-slide-toggle [checked]="(file$ |async)?.syncLayerNormalizers"
            (change)="setFileNormalizerSyncEvent$.next($event.checked)" color="primary" i18n>
            Keep brightness and contrast settings synced across all layers
          </mat-slide-toggle>
        </div> -->

        <!-- <ng-container *ngIf="(file$ |async)?.syncLayerNormalizers"> -->
        <ng-container *ngIf="compositeNormalizersSynced$ | async; else notSyncedBlock">
          <div class="pb-4 pt-1" *ngIf="compositeNormalizer$ | async; let compositeNormalizer">
            <h3 i18n>Brightness and Contrast Settings</h3>
            <div class="pb-4" fxLayout="row wrap" fxLayoutGap="5px">
              <div class="m-2">
                <button mat-raised-button (click)="onPresetClick('faint')" i18n-aria-label
                  aria-label="Faint Target Preset">
                  <mat-icon>brightness_3</mat-icon><span i18n>Faint Target</span>
                </button>
              </div>
              <div class="m-2">
                <button mat-raised-button (click)="onPresetClick('default')" i18n-aria-label
                  aria-label="Default Preset">
                  <mat-icon>brightness_2</mat-icon><span i18n>Default Preset</span>
                </button>
              </div>
              <div class="m-2">
                <button mat-raised-button (click)="onPresetClick('bright')" i18n-aria-label
                  aria-label="Bright Target Preset">
                  <mat-icon>brightness_5</mat-icon><span i18n>Bright Target</span>
                </button>
              </div>
            </div>


            <app-normalizer-form [normalizer]="compositeNormalizer" [showMode]="true" [showColorMap]="false"
              [showInverted]="false" [showStretchMode]="true" [showLayerOffset]="false" [showLayerScale]="false"
              (backgroundLevelChange)="onBackgroundLevelChange($event)" (midLevelChange)="onMidLevelChange($event)"
              (peakLevelChange)="onPeakLevelChange($event)"
              (backgroundPercentileChange)="onBackgroundPercentileChange($event)"
              (midPercentileChange)="onMidPercentileChange($event)"
              (peakPercentileChange)="onPeakPercentileChange($event)" (stretchModeChange)="onStretchModeChange($event)"
              (modeChange)="onNormalizerModeChange($event)">
            </app-normalizer-form>
          </div>
        </ng-container>

        <ng-template #notSyncedBlock>
          <div class="alert alert-warning" style="margin-top: 10px" i18n>
            Brightness and contrast settings are not the same in all layers. In order to change the brightness and
            contrast here, you must first click the sync button below to set all
            brightness and contrast settings to match the selected reference layer.
          </div>

          <div class="w-full flex flex-row justify-center items-center">
            <mat-form-field appearance="outline" class="pr-2.5 mt-5">
              <mat-label i18n>Reference Layer</mat-label>
              <mat-select #referenceLayerSelect>
                <mat-option *ngFor="let layer of (referenceLayerOptions$ | async)" [value]="layer.id">{{layer.name}}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-raised-button (click)="onSyncClick(referenceLayerSelect.value)" i18n-aria-label
              aria-label="Sync brighness and contrast"
              [disabled]="!referenceLayerSelect.value || !file?.layerIds.includes(referenceLayerSelect.value)">
              Sync Brightness & Contrast in all Layers
            </button>
          </div>

        </ng-template>


        <!-- </ng-container> -->

        <!-- <div fxFlexLayout="column" fxLayoutGap="10px">
          <div fxFlexLayout="row" fxLayoutGap="15px">
            <div style="width: 100px;">Red</div>
            <mat-form-field style="width: 50px;">
              <mat-label>R</mat-label><input matInput type="number" [formControl]="channelMixerControls[0][0]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>G</mat-label><input matInput type="number" [formControl]="channelMixerControls[0][1]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>B</mat-label><input matInput type="number" [formControl]="channelMixerControls[0][2]"
                step="0.05" />
            </mat-form-field>
          </div>
          <div fxFlexLayout="row" fxLayoutGap="15px">
            <div style="width: 100px;">Green</div>
            <mat-form-field style="width: 50px;">
              <mat-label>R</mat-label><input matInput type="number" [formControl]="channelMixerControls[1][0]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>G</mat-label><input matInput type="number" [formControl]="channelMixerControls[1][1]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>B</mat-label><input matInput type="number" [formControl]="channelMixerControls[1][2]"
                step="0.05" />
            </mat-form-field>
          </div>
          <div fxFlexLayout="row" fxLayoutGap="15px">
            <div style="width: 100px;">Blue</div>
            <mat-form-field style="width: 50px;">
              <mat-label>R</mat-label><input matInput type="number" [formControl]="channelMixerControls[2][0]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>G</mat-label><input matInput type="number" [formControl]="channelMixerControls[2][1]"
                step="0.05" />
            </mat-form-field>
            <mat-form-field style="width: 50px;">
              <mat-label>B</mat-label><input matInput type="number" [formControl]="channelMixerControls[2][2]"
                step="0.05" />
            </mat-form-field>
          </div>
        </div> -->

      </div>
    </ng-container>

  </ng-template>

  <hr>
  <div>
    <h3 i18n>Image Orientation Options</h3>
    <div class="pb-4">
      <app-image-orientation-toolbar [data]="(activeImageLayer$ | async) || (file$ | async)"
        [viewportSize]="viewportSize$ | async"></app-image-orientation-toolbar>
    </div>
  </div>
</ng-container>