<div
  fxFlex="1 1 0%"
  class="image-viewer-grid-panel"
  role="region"
  aria-label="image viewers"
  [fxShow]="
    !(inFullScreenMode$ | async) || (fullScreenPanel$ | async) == 'viewer'
  "
>
<app-workbench-viewer-grid [viewers]="viewers$ | async" [activeViewerId]="activeViewerId$ | async" [viewMode]="viewMode$ | async"></app-workbench-viewer-grid>

</div>

<span class="resizer"></span>
<div
  *ngIf="showConfig$ | async"
  fxFlex="0 0 auto"
  class="workbench-config-panel"
  role="region"
  aria-labelledby="settings-header"
  [ngClass]="{ 'full-screen': inFullScreenMode$ | async }"
  [fxShow]="
    !(inFullScreenMode$ | async) || (fullScreenPanel$ | async) == 'tool'
  "
>
  <div class="card workbench-settings-card" style="height: 100%;">
    <div id="settings-header" class="card-header">
      <h5>Stacker</h5>
    </div>

    <div class="card-body" style="overflow-y: auto;">
      <div *ngIf="allImageFiles$ | async; let allImageFiles">
        <form [formGroup]="stackForm">
          <div>
            <mat-form-field appearance="outline" style="width: 300px;">
              <mat-label>Select Image(s) to Stack</mat-label>
              <mat-select multiple formControlName="selectedImageFileIds">
                <mat-option
                  *ngFor="let imageFile of allImageFiles"
                  [value]="imageFile.id"
                  >{{ imageFile.name }}</mat-option
                >
              </mat-select>
            </mat-form-field>

            <button mat-icon-button (click)="selectImageFiles(allImageFiles)">
              <mat-icon>select_all</mat-icon>
            </button>

            <button mat-icon-button (click)="selectImageFiles([])">
              <mat-icon>clear</mat-icon>
            </button>
          </div>

          <div>
            <mat-form-field appearance="outline" style="width: 200px;">
              <mat-label>Mode</mat-label>
              <mat-select formControlName="mode">
                <mat-option value="average">average</mat-option>
                <mat-option value="percentile">percentile</mat-option>
                <mat-option value="mode">mode</mat-option>
                <mat-option value="sum">sum</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              [hidden]="stackForm.value?.mode != 'percentile'" style="margin-left: 10px;"
            >
              <mat-label>Percentile</mat-label>
              <input matInput formControlName="percentile" type="number" />
            </mat-form-field>
          </div>

          <div>
            <mat-form-field appearance="outline" style="width: 300px;">
              <mat-label>Rejection</mat-label>
              <mat-select formControlName="rejection">
                <mat-option value="none">None</mat-option>
                <mat-option value="chauvenet">chauvenet</mat-option>
                <mat-option value="iraf">iraf</mat-option>
                <mat-option value="minmax">minmax</mat-option>
                <mat-option value="sigclip">sigclip</mat-option>
              </mat-select>
            </mat-form-field>
            
          </div>

          <div>
              <mat-form-field
              appearance="outline"
              [hidden]="!['iraf', 'minmax', 'sigclip'].includes(stackForm.value?.rejection)"
            >
              <mat-label>Low</mat-label>
              <input matInput formControlName="low" type="number" />
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              [hidden]="!['iraf', 'minmax', 'sigclip'].includes(stackForm.value?.rejection)"  style="margin-left: 10px;"
            >
              <mat-label>High</mat-label>
              <input matInput formControlName="high" type="number" />
            </mat-form-field>
          </div>

          <div>
            <mat-form-field appearance="outline" style="width: 300px;">
              <mat-label>Scaling</mat-label>
              <mat-select formControlName="scaling">
                <mat-option value="none">None</mat-option>
                <mat-option value="average">average</mat-option>
                <mat-option value="median">median</mat-option>
                <mat-option value="mode">mode</mat-option>
              </mat-select>
            </mat-form-field>
          </div>


          <div style="clear: both;"></div>
          <button
            mat-raised-button
            (click)="submit(stackForm.value)"
            [disabled]="!stackForm.valid"
            class="float-right"
          >
            Submit
          </button>
          <div style="clear: both;"></div>
        </form>

        <!-- <div *ngIf="showCurrentPixelOpsJobState$ | async" style="padding-top: 10px;"> -->
        <div
          *ngIf="stackJobRow$ | async; let jobRow"
          style="margin-top: 10px;"
        >
          <div
            class="alert alert-info"
            *ngIf="
              !jobRow.result ||
                ['pending', 'in_progress'].includes(jobRow.job.state.status);
              else jobComplete
            "
          >
            Processing job {{ jobRow.job.id }} ... ({{
              jobRow.job.state.progress | number: "1.0-0"
            }}%)

            <ng-container *ngIf="jobRow.job.state.status == 'in_progress'">
              <div style="margin-top: 5px">
                <mat-progress-bar
                  mode="determinate"
                  [value]="jobRow.job.state.progress"
                  [color]="'primary'"
                ></mat-progress-bar>
              </div>
            </ng-container>
          </div>
          <ng-template #jobComplete>
            <div
              *ngIf="jobRow.result.errors.length != 0; else noErrors"
              class="alert alert-danger"
            >
              {{ jobRow.result.errors }}
            </div>
            <ng-template #noErrors>
              <div class="alert alert-success">
                Processing is complete.
              </div>
            </ng-template>
          </ng-template>
        </div>
        <!-- </div> -->
      </div>
    </div>
  </div>
</div>
