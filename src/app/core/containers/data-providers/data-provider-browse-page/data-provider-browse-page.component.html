<div class="container-fluid pt-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a [routerLink]="['/import']">Import</a></li>
    <li *ngIf="(currentProvider$ | async)" class="breadcrumb-item active">{{(currentProvider$ | async)?.name}} - Browse</li>
    <div class="float-right">
      <button mat-raised-button (click)="onSelectAll(true)">Select All</button>
      <button mat-raised-button (click)="onSelectAll(false)">Deselect All</button>
      <button mat-raised-button (click)="import()" [disabled]="(selectedAssets$ | async)?.length == 0 || (importing$ | async)">Import</button>
     
    </div>
  </ol>
  <div *ngIf="(currentProvider$ | async)">
    <div class="container pt-1">
      
      <mat-progress-bar *ngIf="(importing$ | async)" mode="determinate" [value]="(importProgress$ | async) * 100" [color]="'primary'"></mat-progress-bar>
      <div *ngIf="(importing$ | async)" class="alert alert-info">
          Importing selected assets... ({{(pendingImports$ | async)?.length}} remaining)
      </div>
      <div *ngIf="(importProgress$ | async) == 1.0 && (completedImports$ | async).length != 0 && (completedImports$ | async).length > (importErrors$ | async).length"
        class="alert"
        [ngClass]="((importErrors$ | async).length == 0)?'alert-success':'alert-warning'">
          Import completed with {{(importErrors$ | async).length == 0 ? 'no' : (importErrors$ | async).length}} error(s). 
          <a routerLink="/workbench" class="alert-link">View your imported files now.</a>
      </div>
      
      <div *ngIf="(importErrors$ | async).length != 0" class="alert alert-danger" role="alert">
        <div *ngFor="let e of (importErrors$ | async)">
            <strong>Error: </strong> Failed to import {{e.asset.name}}. <span *ngIf="e.message">{{e.message}}</span>
        </div>
      </div>
      <div *ngIf="(loadingAssets$ | async)" class="alert alert-info">
          Loading assets...
      </div>
      <div *ngIf="!(loadingAssets$ | async)">
        <mat-card class="pb-3">
          <mat-card-header>
            <div class="pb-3" style="width: 100%">
                <span *ngFor="let breadcrumb of (currentPathBreadcrumbs$ | async)">
                  <strong>
                    <span *ngIf="breadcrumb.url != null">
                      <a class="collection p-2 text-center" [routerLink]="[]" [queryParams]="{path: breadcrumb.url}" >{{breadcrumb.name}}</a>
                    </span>
                    <span *ngIf="breadcrumb.url == null">
                      {{breadcrumb.name}}
                    </span>
                    /
                  </strong>
                </span>
                <span class="float-right"><strong>{{(selectedAssets$ | async).length}}</strong> image files selected.</span>
                <div style="clear: both;"></div>
              </div>
          </mat-card-header>
          
          
  
          <div class="pb-3">
            <table td-data-table>
                <thead>
                  <tr td-data-table-column-row>
                    <th td-data-table-column [width]="70">
                      <mat-checkbox
                        #checkBoxAll
                        [indeterminate]="selectAllIndeterminate && !allSelected"
                        [checked]="allSelected"
                        (click)="blockEvent($event); onSelectAll(!checkBoxAll.checked)"
                        (keyup.enter)="selectAll(!checkBoxAll.checked)"
                        (keyup.space)="selectAll(!checkBoxAll.checked)"
                        (keydown.space)="blockEvent($event)">
                      </mat-checkbox>
                    </th>
                    <th td-data-table-column
                      [name]="'name'"
                      [sortable]="true"
                      [sortOrder]="(sortOrder$ | async)"
                      (sortChange)="onSortChange($event)"
                      [active]="(sortField$ | async) == 'name'">
                      Name
                    </th>
                    <th td-data-table-column
                      *ngFor="let column of (currentProvider$ | async)?.columns"
                      [name]="column.fieldName"
                      [sortable]="column.sortable"
                      [sortOrder]="(sortOrder$ | async)"
                      (sortChange)="onSortChange($event)"
                      [active]="(sortField$ | async) == column.fieldName">
                      {{column.name}}
                    </th>
                  </tr>
                </thead>
                
                <tbody>
                  <tr td-data-table-row
                    [tabIndex]="0"
                    (keyup)="rowKeyup($event, row)"
                    (keydown.space)="blockEvent($event)"
                    (keydown.shift.space)="blockEvent($event)"
                    (keydown.shift)="disableTextSelection()"
                    (keyup.shift)="enableTextSelection()"
                    (click)="onAssetClick($event, row)"
                    *ngFor="let row of (currentAssets$ | async)">
                    <td td-data-table-cell>
                      <mat-pseudo-checkbox
                        *ngIf="!row.collection"
                        class="ml-3"
                        [state]="(selectedAssets$ | async)?.includes(row) ? 'checked' : 'unchecked'">
                      </mat-pseudo-checkbox>
      
                    </td>
                    <td td-data-table-cell>
                      <div class="valign-center" *ngIf="row.collection">
                        <mat-icon class="mr-1">folder</mat-icon>
                        <a [routerLink]="[]" [queryParams]="{path: row.path}" >
                            {{row.name}}
                        </a>
                      </div>
                      <div class="valign-center" *ngIf="!row.collection">
                        <mat-icon class="mr-1">photo</mat-icon>
                        {{row.name}}
                      </div>
                    </td>
                    <td td-data-table-cell *ngFor="let column of (currentProvider$ | async)?.columns">
                      <span *ngIf="row.metadata && row.metadata.hasOwnProperty(column.fieldName)">
                        {{row.metadata[column.fieldName]}}
                      </span>
                    </td>
                    
                  </tr>
                </tbody>
              </table>
          </div>
          <div class="text-center">
              <button mat-raised-button (click)="import()"  [disabled]="(selectedAssets$ | async)?.length == 0 || (importing$ | async)"><mat-icon>file_download</mat-icon> Import</button>
            </div>

        </mat-card>
        
      </div>
    </div>
  </div>

</div>


